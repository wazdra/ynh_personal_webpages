#!/bin/bash

#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

### Install parameters are automatically saved as settings
###
### Settings are automatically loaded as bash variables
### in every app script context, therefore typically these will exist:
### - $domain
### - $path
### - $language
### ... etc
###
### Resources defined in the manifest are provisioned prior to this script
### and corresponding settings are also available, such as:
### - $install_dir
### - $port
### - $db_name
### ...
###
### $app is the app id (i.e. 'example' for first install,
### or 'example__2', '__3'... for multi-instance installs)

#=================================================
# INITIALIZE AND STORE SETTINGS
#=================================================

# Save the base path for later changes via config panel
ynh_app_setting_set --key=base_path --value="$path"

# Ensure data_dir substructure exists
mkdir -p "$data_dir/exports"
chown -R "$app:www-data" "$data_dir"
chmod 0755 "$data_dir" "$data_dir/exports"

#=================================================
# SYSTEM CONFIGURATION (NGINX ONLY)
#=================================================
ynh_script_progression "Configuring NGINX for $app..."

# Provide Nginx template with DATA_DIR var
export DATA_DIR="$data_dir"
ynh_config_add_nginx

#=================================================
# PROVISION EXISTING USERS' DIRECTORIES (best-effort)
#=================================================
ynh_script_progression "Provisioning existing users' public_html exports..."

provision_userdir() {
	local u="$1"
	local home="/home/$u"
	local src="$home/public_html"
	local dst="$data_dir/exports/$u"

	# Create source dir in user's home if missing
	if [ ! -d "$src" ]; then
		mkdir -p "$src"
		chown "$u:$u" "$src"
		chmod 0755 "$src"
	fi

	# Create destination mirror dir and bind-mount read-only via fstab
	mkdir -p "$dst"
	chown "$app:www-data" "$dst"
	chmod 0755 "$dst"

	# Add or ensure bind mount in fstab
	if ! grep -q "^$src[[:space:]]\+$dst[[:space:]]\+none[[:space:]]\+bind,ro" /etc/fstab; then
		echo "$src $dst none bind,ro 0 0" >> /etc/fstab
	fi

	# Mount (idempotent)
	mountpoint -q "$dst" || mount "$dst" || true
}

# Iterate over YunoHost users with ssh access (= group 'ssh')
if getent group ssh >/dev/null; then
	for u in $(getent group ssh | awk -F: '{print $4}' | tr ',' ' '); do
		[ -n "$u" ] && provision_userdir "$u"
	done
fi

# Reload nginx to apply configuration
ynh_systemctl --service=nginx --action=reload

#=================================================
# CRON: keep user exports provisioned
#=================================================
# Install helper script
mkdir -p "/opt/yunohost/$app"
cp "$(dirname "$0")/ynh-hook-provision" "/opt/yunohost/$app/ynh-hook-provision"
chmod 0755 "/opt/yunohost/$app/ynh-hook-provision"

echo "@daily root /bin/bash /opt/yunohost/$app/ynh-hook-provision >/dev/null 2>&1" > "/etc/cron.d/$app"
chmod 0644 "/etc/cron.d/$app"

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression "Installation of $app completed"
