#!/bin/bash

#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

### Settings are automatically loaded as bash variables
### in every app script context, therefore typically these will exist:
### - $domain
### - $path
### - $language
### - $install_dir
### - $port
### ...

### For remove operations:
### - the core will deprovision every resource defined in the manifest **after** this script is ran
### this includes removing the install directory, and data directory (if --purge was used)

#=================================================
# REMOVE SYSTEM CONFIGURATION
#=================================================
ynh_script_progression "Removing NGINX configuration and unmounting user exports..."

# Remove Nginx configuration
ynh_config_remove_nginx

# Unmount bind mounts and clean fstab entries
if [ -d "$data_dir/exports" ]; then
    while read -r line; do
        src=$(echo "$line" | awk '{print $1}')
        dst=$(echo "$line" | awk '{print $2}')
        if echo "$dst" | grep -q "^$data_dir/exports/"; then
            mountpoint -q "$dst" && umount "$dst" || true
        fi
    done < <(grep " $data_dir/exports/" /etc/fstab || true)
    # Remove fstab lines
    if grep -q " $data_dir/exports/" /etc/fstab; then
        cp /etc/fstab /etc/fstab.bak.$app
        grep -v " $data_dir/exports/" /etc/fstab.bak.$app > /etc/fstab
    fi
fi

# Remove cron and helper
ynh_safe_rm "/etc/cron.d/$app"
ynh_safe_rm "/opt/yunohost/$app/ynh-hook-provision"
ynh_safe_rm "/opt/yunohost/$app"

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression "Removal of $app completed"
