#!/bin/bash

#=================================================
# IMPORT GENERIC HELPERS
#=================================================

# Keep this path for calling _common.sh inside the execution's context of backup and restore scripts
source ../settings/scripts/_common.sh
source /usr/share/yunohost/helpers

#=================================================
# RESTORE THE APP MAIN DIR
#=================================================
ynh_script_progression "Restoring the data directory..."

ynh_restore "$data_dir"
chown -R "$app:www-data" "$data_dir"
chmod 0755 "$data_dir" || true

# Restore Nginx configuration
ynh_script_progression "Restoring NGINX configuration..."
ynh_restore "/etc/nginx/conf.d/$domain.d/$app.conf"

# Remount bind mounts listed in fstab for this app
ynh_script_progression "Remounting user exports..."
if [ -d "$data_dir/exports" ]; then
	for d in "$data_dir"/exports/*; do
		[ -d "$d" ] || continue
		mountpoint -q "$d" || mount "$d" || true
	done
fi

# Reload nginx to apply configuration
ynh_systemctl --service=nginx --action=reload

# Restore cron and helper if present in backup
ynh_restore "/etc/cron.d/$app" || true
ynh_restore "/opt/yunohost/$app/ynh-hook-provision" || true
chmod 0755 "/opt/yunohost/$app/ynh-hook-provision" 2>/dev/null || true

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression "Restoration completed for $app"
