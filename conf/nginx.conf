# Base path entry point. No index listing here.
location = __PATH__/ {
  return 404;
}

# Serve static content from users' public_html via bind-mounted exports.
# URL scheme: __PATH__/~username/...
# Allowed username charset mirrors YunoHost usernames (lowercase alnum, dash and underscore)
location ~ ^__PATH__/~(?<u>[a-z0-9_-]+)(?<rest>/.*)?$ {
  # Do not follow symlinks for security
  disable_symlinks on;

  # Hide dotfiles (but allow .well-known)
  if ($uri ~ (^|/)\.(?!well-known/)) { return 404; }

  # Static only: only GET and HEAD
  limit_except GET HEAD { return 405; }

  # Map to the exported bind mount for this user
  alias __DATA_DIR__/exports/$u$rest;

  # Default index file if URL ends with '/'
  index index.html index.htm;

  # No directory listing
  autoindex off;

  # Large files allowed (uploads not used here)
  client_max_body_size 0;
}
